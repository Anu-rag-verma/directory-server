/*
 *                                 Apache License
 *                           Version 2.0, January 2004
 *                        http://www.apache.org/licenses/
 *
 *   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION
 *
 *   1. Definitions.
 *
 *      "License" shall mean the terms and conditions for use, reproduction,
 *      and distribution as defined by Sections 1 through 9 of this document.
 *
 *      "Licensor" shall mean the copyright owner or entity authorized by
 *      the copyright owner that is granting the License.
 *
 *      "Legal Entity" shall mean the union of the acting entity and all
 *      other entities that control, are controlled by, or are under common
 *      control with that entity. For the purposes of this definition,
 *      "control" means (i) the power, direct or indirect, to cause the
 *      direction or management of such entity, whether by contract or
 *      otherwise, or (ii) ownership of fifty percent (50%) or more of the
 *      outstanding shares, or (iii) beneficial ownership of such entity.
 *
 *      "You" (or "Your") shall mean an individual or Legal Entity
 *      exercising permissions granted by this License.
 *
 *      "Source" form shall mean the preferred form for making modifications,
 *      including but not limited to software source code, documentation
 *      source, and configuration files.
 *
 *      "Object" form shall mean any form resulting from mechanical
 *      transformation or translation of a Source form, including but
 *      not limited to compiled object code, generated documentation,
 *      and conversions to other media types.
 *
 *      "Work" shall mean the work of authorship, whether in Source or
 *      Object form, made available under the License, as indicated by a
 *      copyright notice that is included in or attached to the work
 *      (an example is provided in the Appendix below).
 *
 *      "Derivative Works" shall mean any work, whether in Source or Object
 *      form, that is based on (or derived from) the Work and for which the
 *      editorial revisions, annotations, elaborations, or other modifications
 *      represent, as a whole, an original work of authorship. For the purposes
 *      of this License, Derivative Works shall not include works that remain
 *      separable from, or merely link (or bind by name) to the interfaces of,
 *      the Work and Derivative Works thereof.
 *
 *      "Contribution" shall mean any work of authorship, including
 *      the original version of the Work and any modifications or additions
 *      to that Work or Derivative Works thereof, that is intentionally
 *      submitted to Licensor for inclusion in the Work by the copyright owner
 *      or by an individual or Legal Entity authorized to submit on behalf of
 *      the copyright owner. For the purposes of this definition, "submitted"
 *      means any form of electronic, verbal, or written communication sent
 *      to the Licensor or its representatives, including but not limited to
 *      communication on electronic mailing lists, source code control systems,
 *      and issue tracking systems that are managed by, or on behalf of, the
 *      Licensor for the purpose of discussing and improving the Work, but
 *      excluding communication that is conspicuously marked or otherwise
 *      designated in writing by the copyright owner as "Not a Contribution."
 *
 *      "Contributor" shall mean Licensor and any individual or Legal Entity
 *      on behalf of whom a Contribution has been received by Licensor and
 *      subsequently incorporated within the Work.
 *
 *   2. Grant of Copyright License. Subject to the terms and conditions of
 *      this License, each Contributor hereby grants to You a perpetual,
 *      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
 *      copyright license to reproduce, prepare Derivative Works of,
 *      publicly display, publicly perform, sublicense, and distribute the
 *      Work and such Derivative Works in Source or Object form.
 *
 *   3. Grant of Patent License. Subject to the terms and conditions of
 *      this License, each Contributor hereby grants to You a perpetual,
 *      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
 *      (except as stated in this section) patent license to make, have made,
 *      use, offer to sell, sell, import, and otherwise transfer the Work,
 *      where such license applies only to those patent claims licensable
 *      by such Contributor that are necessarily infringed by their
 *      Contribution(s) alone or by combination of their Contribution(s)
 *      with the Work to which such Contribution(s) was submitted. If You
 *      institute patent litigation against any entity (including a
 *      cross-claim or counterclaim in a lawsuit) alleging that the Work
 *      or a Contribution incorporated within the Work constitutes direct
 *      or contributory patent infringement, then any patent licenses
 *      granted to You under this License for that Work shall terminate
 *      as of the date such litigation is filed.
 *
 *   4. Redistribution. You may reproduce and distribute copies of the
 *      Work or Derivative Works thereof in any medium, with or without
 *      modifications, and in Source or Object form, provided that You
 *      meet the following conditions:
 *
 *      (a) You must give any other recipients of the Work or
 *          Derivative Works a copy of this License; and
 *
 *      (b) You must cause any modified files to carry prominent notices
 *          stating that You changed the files; and
 *
 *      (c) You must retain, in the Source form of any Derivative Works
 *          that You distribute, all copyright, patent, trademark, and
 *          attribution notices from the Source form of the Work,
 *          excluding those notices that do not pertain to any part of
 *          the Derivative Works; and
 *
 *      (d) If the Work includes a "NOTICE" text file as part of its
 *          distribution, then any Derivative Works that You distribute must
 *          include a readable copy of the attribution notices contained
 *          within such NOTICE file, excluding those notices that do not
 *          pertain to any part of the Derivative Works, in at least one
 *          of the following places: within a NOTICE text file distributed
 *          as part of the Derivative Works; within the Source form or
 *          documentation, if provided along with the Derivative Works; or,
 *          within a display generated by the Derivative Works, if and
 *          wherever such third-party notices normally appear. The contents
 *          of the NOTICE file are for informational purposes only and
 *          do not modify the License. You may add Your own attribution
 *          notices within Derivative Works that You distribute, alongside
 *          or as an addendum to the NOTICE text from the Work, provided
 *          that such additional attribution notices cannot be construed
 *          as modifying the License.
 *
 *      You may add Your own copyright statement to Your modifications and
 *      may provide additional or different license terms and conditions
 *      for use, reproduction, or distribution of Your modifications, or
 *      for any such Derivative Works as a whole, provided Your use,
 *      reproduction, and distribution of the Work otherwise complies with
 *      the conditions stated in this License.
 *
 *   5. Submission of Contributions. Unless You explicitly state otherwise,
 *      any Contribution intentionally submitted for inclusion in the Work
 *      by You to the Licensor shall be under the terms and conditions of
 *      this License, without any additional terms or conditions.
 *      Notwithstanding the above, nothing herein shall supersede or modify
 *      the terms of any separate license agreement you may have executed
 *      with Licensor regarding such Contributions.
 *
 *   6. Trademarks. This License does not grant permission to use the trade
 *      names, trademarks, service marks, or product names of the Licensor,
 *      except as required for reasonable and customary use in describing the
 *      origin of the Work and reproducing the content of the NOTICE file.
 *
 *   7. Disclaimer of Warranty. Unless required by applicable law or
 *      agreed to in writing, Licensor provides the Work (and each
 *      Contributor provides its Contributions) on an "AS IS" BASIS,
 *      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
 *      implied, including, without limitation, any warranties or conditions
 *      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
 *      PARTICULAR PURPOSE. You are solely responsible for determining the
 *      appropriateness of using or redistributing the Work and assume any
 *      risks associated with Your exercise of permissions under this License.
 *
 *   8. Limitation of Liability. In no event and under no legal theory,
 *      whether in tort (including negligence), contract, or otherwise,
 *      unless required by applicable law (such as deliberate and grossly
 *      negligent acts) or agreed to in writing, shall any Contributor be
 *      liable to You for damages, including any direct, indirect, special,
 *      incidental, or consequential damages of any character arising as a
 *      result of this License or out of the use or inability to use the
 *      Work (including but not limited to damages for loss of goodwill,
 *      work stoppage, computer failure or malfunction, or any and all
 *      other commercial damages or losses), even if such Contributor
 *      has been advised of the possibility of such damages.
 *
 *   9. Accepting Warranty or Additional Liability. While redistributing
 *      the Work or Derivative Works thereof, You may choose to offer,
 *      and charge a fee for, acceptance of support, warranty, indemnity,
 *      or other liability obligations and/or rights consistent with this
 *      License. However, in accepting such obligations, You may act only
 *      on Your own behalf and on Your sole responsibility, not on behalf
 *      of any other Contributor, and only if You agree to indemnify,
 *      defend, and hold each Contributor harmless for any liability
 *      incurred by, or claims asserted against, such Contributor by reason
 *      of your accepting any such warranty or additional liability.
 *
 *   END OF TERMS AND CONDITIONS
 *
 *   APPENDIX: How to apply the Apache License to your work.
 *
 *      To apply the Apache License to your work, attach the following
 *      boilerplate notice, with the fields enclosed by brackets "[]"
 *      replaced with your own identifying information. (Don't include
 *      the brackets!)  The text should be enclosed in the appropriate
 *      comment syntax for the file format. We also recommend that a
 *      file or class name and description of purpose be included on the
 *      same "printed page" as the copyright notice for easier
 *      identification within third-party archives.
 *
 *   Copyright [yyyy] [name of copyright owner]
 *
 *   Licensed under the Apache License, Version 2.0 (the "License");
 *   you may not use this file except in compliance with the License.
 *   You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *   Unless required by applicable law or agreed to in writing, software
 *   distributed under the License is distributed on an "AS IS" BASIS,
 *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *   See the License for the specific language governing permissions and
 *   limitations under the License.
 *
 */

/*
 * $Id: DirServerContext.java,v 1.4 2003/11/28 15:46:21 akarasulu Exp $
 *
 * -- (c) LDAPd Group                                                    --
 * -- Please refer to the LICENSE.txt file in the root directory of      --
 * -- any LDAPd project for copyright and distribution information.      --
 *
 * Created on Aug 6, 2003
 */
package org.apache.ldap.server.jndi ;


import java.io.IOException ;
import java.util.Hashtable ;
import java.text.ParseException ;

import javax.naming.Name ;
import javax.naming.ldap.Control ;
import javax.naming.NamingException ;
import javax.naming.ldap.LdapContext ;
import javax.naming.NamingEnumeration ;
import javax.naming.directory.Attribute;
import javax.naming.directory.Attributes ;
import javax.naming.directory.DirContext ;
import javax.naming.directory.SearchControls ;
import javax.naming.directory.ModificationItem ;
import javax.naming.directory.InvalidSearchFilterException ;

import org.apache.ldap.common.name.LdapName ;
import org.apache.ldap.common.filter.ExprNode ;
import org.apache.ldap.common.filter.BranchNode ;
import org.apache.ldap.common.filter.SimpleNode ;
import org.apache.ldap.common.filter.PresenceNode ;
import org.apache.ldap.common.filter.FilterParser ;
import org.apache.ldap.common.util.NamespaceTools ;
import org.apache.ldap.common.filter.FilterParserImpl ;

import org.apache.ldap.server.nexus.BackendNexus ;


/**
 * The DirContext implementation for the Server Side JNDI LDAP provider.
 *
 * @author <a href="mailto:aok123@bellsouth.net">Alex Karasulu</a>
 * @author $Author: akarasulu $
 * @version $Revision: 1.4 $
 */
public class DirServerContext
    extends ServerContext
    implements DirContext
{
    
    
    // ------------------------------------------------------------------------
    // Constructors
    // ------------------------------------------------------------------------
    
    /**
     * Creates a new DirServerContext by reading the PROVIDER_URL to resolve the
     * distinguished name for this context.
     *
     * @param a_nexusProxy the proxy to the backend nexus
     * @param a_env the environment used for this context
     * @throws NamingException if something goes wrong
     */
    public DirServerContext( BackendNexus a_nexusProxy, Hashtable a_env )
        throws NamingException
    {
        super( a_nexusProxy, a_env ) ;
    }


    /**
     * Creates a new DirServerContext with a distinguished name which is used to
     * set the PROVIDER_URL to the distinguished name for this context.
     * 
     * @param a_nexusProxy the intercepting proxy to the nexus
     * @param a_env the environment properties used by this context
     * @param a_dn the distinguished name of this context
     * @throws NamingException if the environment parameters are not set 
     * correctly
     */
    protected DirServerContext( BackendNexus a_nexusProxy, Hashtable a_env,
        LdapName a_dn )
        throws NamingException
    {
        super( a_nexusProxy, a_env, a_dn ) ;
    }


    // ------------------------------------------------------------------------
    // DirContext Implementations
    // ------------------------------------------------------------------------


    /**
     * @see javax.naming.directory.DirContext#getAttributes(java.lang.String)
     */
    public Attributes getAttributes( String a_name ) throws NamingException
    {
        return getAttributes( new LdapName( a_name ) ) ;
    }
    

    /**
     * @see javax.naming.directory.DirContext#getAttributes(javax.naming.Name)
     */
    public Attributes getAttributes( Name a_name ) throws NamingException
    {
        return getNexusProxy().lookup( buildTarget( a_name ) ) ;
    }


    /**
     * @see javax.naming.directory.DirContext#getAttributes(java.lang.String,
     *      java.lang.String[])
     */
    public Attributes getAttributes( String a_name, String[] a_attrIds )
        throws NamingException
    {
        return getAttributes( new LdapName( a_name ), a_attrIds ) ;
    }


    /**
     * @see javax.naming.directory.DirContext#getAttributes(javax.naming.Name,
     *      java.lang.String[])
     */
    public Attributes getAttributes( Name a_name, String[] a_attrIds )
        throws NamingException
    {
        return getNexusProxy().lookup( buildTarget( a_name ), a_attrIds ) ;
    }
    

    /**
     * @see javax.naming.directory.DirContext#modifyAttributes(java.lang.String,
     *      int, javax.naming.directory.Attributes)
     */
    public void modifyAttributes( String a_name, int a_modOp, 
        Attributes a_attrs ) throws NamingException
    {
        modifyAttributes( new LdapName( a_name ), a_modOp, a_attrs ) ;
    }


    /**
     * @see javax.naming.directory.DirContext#modifyAttributes(
     * javax.naming.Name,int, javax.naming.directory.Attributes)
     */
    public void modifyAttributes( Name a_name, int a_modOp, Attributes a_attrs )
        throws NamingException
    {
        getNexusProxy().modify( buildTarget( a_name ), a_modOp, a_attrs ) ;
    }


    /**
     * @see javax.naming.directory.DirContext#modifyAttributes(java.lang.String,
     *      javax.naming.directory.ModificationItem[])
     */
    public void modifyAttributes( String a_name, ModificationItem[] a_mods )
        throws NamingException
    {
        modifyAttributes( new LdapName( a_name ), a_mods ) ;
    }


    /**
     * @see javax.naming.directory.DirContext#modifyAttributes(
     * javax.naming.Name, javax.naming.directory.ModificationItem[])
     */
    public void modifyAttributes( Name a_name, ModificationItem[] a_mods )
        throws NamingException
    {
        getNexusProxy().modify( buildTarget( a_name ), a_mods ) ;
    }
    

    /**
     * @see javax.naming.directory.DirContext#bind(java.lang.String,
     *      java.lang.Object, javax.naming.directory.Attributes)
     */
    public void bind( String a_name, Object a_obj, Attributes a_attrs )
        throws NamingException
    {
        bind( new LdapName( a_name ), a_obj, a_attrs ) ;
    }


    /**
     * @see javax.naming.directory.DirContext#bind(javax.naming.Name,
     *      java.lang.Object, javax.naming.directory.Attributes)
     */
    public void bind( Name a_name, Object a_obj, Attributes a_attrs )
        throws NamingException
    {
        if ( null == a_obj && null == a_attrs )  
        {
            throw new NamingException( "Both a_obj and a_attrs args are null. "
                + "At least one of these parameters must not be null." ) ;
        }

        // A null a_attrs defaults this to the Context.bind() operation        
        if ( null == a_attrs )
        {
            super.bind( a_name, a_obj ) ;
        }
        // No object binding so we just add the attributes
        else if ( null == a_obj )
        {
            Attributes l_clone = ( Attributes ) a_attrs.clone() ;
            Name l_target = buildTarget( a_name ) ;
            getNexusProxy().add( l_target.toString(), l_target, l_clone ) ;
        }
        // Need to perform serialization of object into a copy of a_attrs
        else 
        {
            if ( a_obj instanceof LdapServerContext )
            {
                throw new IllegalArgumentException(
                    "Cannot bind a directory context object!" ) ;
            }

            Attributes l_clone = ( Attributes ) a_attrs.clone() ;
            JavaLdap.serialize( l_clone, a_obj ) ;
            Name l_target = buildTarget( a_name ) ;
            getNexusProxy().add( l_target.toString(), l_target, l_clone ) ;
        }
    }


    /**
     * @see javax.naming.directory.DirContext#rebind(java.lang.String,
     *      java.lang.Object, javax.naming.directory.Attributes)
     */
    public void rebind( String a_name, Object a_obj, Attributes a_attrs )
        throws NamingException
    {
        rebind( new LdapName( a_name ), a_obj, a_attrs ) ;
    }


    /**
     * @see javax.naming.directory.DirContext#rebind(javax.naming.Name,
     *      java.lang.Object, javax.naming.directory.Attributes)
     */
    public void rebind( Name a_name, Object a_obj, Attributes a_attrs )
        throws NamingException
    {
        Name l_target = buildTarget( a_name ) ;

        if ( getNexusProxy().hasEntry( l_target ) ) 
        {
            getNexusProxy().delete( l_target ) ;
        }

        bind( a_name, a_obj, a_attrs ) ;
    }


    /**
     * @see javax.naming.directory.DirContext#createSubcontext(java.lang.String,
     *      javax.naming.directory.Attributes)
     */
    public DirContext createSubcontext( String a_name, Attributes a_attrs )
        throws NamingException
    {
        return createSubcontext( new LdapName( a_name ), a_attrs ) ;        
    }


    /**
     * @see javax.naming.directory.DirContext#createSubcontext(
     * javax.naming.Name, javax.naming.directory.Attributes)
     */
    public DirContext createSubcontext( Name a_name, Attributes a_attrs )
        throws NamingException
    {
        if ( null == a_attrs )
        {
            return ( DirContext ) super.createSubcontext( a_name ) ;
        }
        
        // @todo again note that we presume single attribute name components
        LdapName l_target = buildTarget( a_name ) ;
        String l_rdn = a_name.get( a_name.size() - 1 ) ;
        String l_rdnAttribute = NamespaceTools.getRdnAttribute( l_rdn ) ;
        String l_rdnValue = NamespaceTools.getRdnValue( l_rdn ) ;

        // Clone the attributes and add the Rdn attributes
        Attributes l_attributes = ( Attributes ) a_attrs.clone() ; 
        l_attributes.put( l_rdnAttribute, l_rdnValue ) ;
        
        // Add the new context to the server which as a side effect adds 
        getNexusProxy().add( l_target.toString(), l_target, l_attributes ) ;

        // Initialize the new context
        LdapServerContext l_ctx = new LdapServerContext( 
            getNexusProxy(), getEnvironment(), l_target ) ;
        Control [] l_controls = ( Control [] )
            ( ( LdapServerContext ) this ).getRequestControls().clone() ; 
        l_ctx.setRequestControls( l_controls ) ;
        return l_ctx ;
    }


    /**
     * Presently unsupported operation!
     *
     * @param a_name TODO
     * @return TODO
     * @throws NamingException all the time.
     * @see javax.naming.directory.DirContext#getSchema(javax.naming.Name)
     */
    public DirContext getSchema( Name a_name ) throws NamingException
    {
        throw new UnsupportedOperationException() ;
    }
    

    /**
     * Presently unsupported operation!
     * 
     * @param a_name TODO
     * @return TODO
     * @throws NamingException all the time.
     * @see javax.naming.directory.DirContext#getSchema(java.lang.String)
     */
    public DirContext getSchema( String a_name ) throws NamingException
    {
        throw new UnsupportedOperationException() ;
    }


    /**
     * Presently unsupported operation!
     * 
     * @param a_name TODO
     * @return TODO
     * @throws NamingException all the time.
     * @see javax.naming.directory.DirContext#getSchemaClassDefinition(
     * javax.naming.Name)
     */
    public DirContext getSchemaClassDefinition( Name a_name )
        throws NamingException
    {
        throw new UnsupportedOperationException() ;
    }


    /**
     * Presently unsupported operation!
     * 
     * @param a_name TODO
     * @return TODO
     * @throws NamingException all the time.
     * @see javax.naming.directory.DirContext#getSchemaClassDefinition(
     * java.lang.String)
     */
    public DirContext getSchemaClassDefinition( String a_name )
        throws NamingException
    {
        throw new UnsupportedOperationException() ;
    }


    // ------------------------------------------------------------------------
    // Search Operation Implementations
    // ------------------------------------------------------------------------


    /**
     * @see javax.naming.directory.DirContext#search(java.lang.String,
     *      javax.naming.directory.Attributes)
     */
    public NamingEnumeration search( String a_name, 
        Attributes a_matchingAttributes ) throws NamingException
    {
        return search( new LdapName( a_name ), a_matchingAttributes, null ) ; 
    }


    /**
     * @see javax.naming.directory.DirContext#search(javax.naming.Name,
     *      javax.naming.directory.Attributes)
     */
    public NamingEnumeration search( Name a_name, 
        Attributes a_matchingAttributes ) throws NamingException
    {
        return search( a_name, a_matchingAttributes, null ) ; 
    }


    /**
     * @see javax.naming.directory.DirContext#search(java.lang.String,
     *      javax.naming.directory.Attributes, java.lang.String[])
     */
    public NamingEnumeration search( String a_name, 
        Attributes a_matchingAttributes, String[] a_attributesToReturn ) 
        throws NamingException
    {
        return search( new LdapName( a_name ), a_matchingAttributes, 
            a_attributesToReturn ) ;
    }


    /**
     * TODO may need to refactor some of this functionality into a filter 
     * utility class in commons.
     * 
     * @see javax.naming.directory.DirContext#search(javax.naming.Name,
     *      javax.naming.directory.Attributes, java.lang.String[])
     */
    public NamingEnumeration search( Name a_name, 
        Attributes a_matchingAttributes, String[] a_attributesToReturn ) 
        throws NamingException
    {
        SearchControls l_ctls = new SearchControls() ;
        LdapName l_target = buildTarget( a_name ) ;

        // If we need to return specific attributes add em to the SearchControls
        if ( null != a_attributesToReturn )
        {
            l_ctls.setReturningAttributes( a_attributesToReturn ) ;
        } 

        // If matchingAttributes is null/empty use a match for everything filter
        if ( null == a_matchingAttributes || a_matchingAttributes.size() <= 0 )
        {
            PresenceNode l_filter = new PresenceNode( "objectClass" ) ;
            return getNexusProxy().search( l_target , getEnvironment(), 
                l_filter, ( ( LdapContext ) this ).getRequestControls(), 
                l_ctls ) ;
        }

        /*
         * Go through the set of attributes using each attribute value pair as 
         * an attribute value assertion within one big AND filter expression.
         */
        Attribute l_attr = null ;
        SimpleNode l_node = null ;
        BranchNode l_filter = new BranchNode( BranchNode.AND ) ;
        NamingEnumeration l_list = a_matchingAttributes.getAll() ;
        
        // Loop through each attribute value pair
        while ( l_list.hasMore() )
        {
            l_attr = ( Attribute ) l_list.next() ;
            
            /*
             * According to JNDI if an attribute in the a_matchingAttributes
             * list does not have any values then we match for just the presence
             * of the attribute in the entry
             */
            if ( l_attr.size() == 0 )
            {
                l_filter.addNode( new PresenceNode( l_attr.getID() ) ) ;
                continue ;
            }
            
            /*
             * With 1 or more value we build a set of simple nodes and add them
             * to the AND node - each attribute value pair is a simple AVA node.
             */
            for ( int ii = 0; ii < l_attr.size(); ii++ )
            {
                Object l_val = l_attr.get( ii ) ;
                
                // Add simpel AVA node if its value is a String 
                if ( l_val instanceof String )
                {
                    l_node = new SimpleNode( l_attr.getID(), 
                        ( String ) l_val, SimpleNode.EQUALITY ) ;
                    l_filter.addNode( l_node ) ;
                }
            }
        }

        return getNexusProxy().search( l_target , getEnvironment(), 
            l_filter, ( ( LdapContext ) this ).getRequestControls(), 
            l_ctls ) ;
    }


    /**
     * @see javax.naming.directory.DirContext#search(java.lang.String,
     *      java.lang.String, javax.naming.directory.SearchControls)
     */
    public NamingEnumeration search( String a_name, String a_filter,
        SearchControls a_cons ) throws NamingException
    {
        return search( new LdapName( a_name ), a_filter, a_cons ) ;
    }


    /**
     * @see javax.naming.directory.DirContext#search(javax.naming.Name,
     *      java.lang.String, javax.naming.directory.SearchControls)
     */
    public NamingEnumeration search( Name a_name, String a_filter,
        SearchControls a_cons ) throws NamingException
    {
        ExprNode l_filter = null ;
        LdapName l_target = buildTarget( a_name ) ;

        try 
        {
            /*
             * TODO Added this parser initialization code to the FilterImpl
             * and have a static class parser that can be globally accessed. 
             */
            FilterParser l_parser = new FilterParserImpl() ;
            l_filter = l_parser.parse( a_filter ) ;
        }
        catch ( ParseException pe )
        {
            InvalidSearchFilterException l_isfe = 
                new InvalidSearchFilterException (
                "Encountered parse exception while parsing the filter: '" 
                + a_filter + "'" ) ;
            l_isfe.setRootCause( pe ) ;
            throw l_isfe ;
        }
        catch ( IOException ioe )
        {
            NamingException l_ne = new NamingException(
                "Parser failed with IO exception on filter: '" 
                + a_filter + "'" ) ;
            l_ne.setRootCause( ioe ) ;
            throw l_ne ;
        }
        
        return getNexusProxy().search( l_target , getEnvironment(), 
            l_filter, ( ( LdapContext ) this ).getRequestControls(), 
            new SearchControls() ) ;
    }


    /**
     * @see javax.naming.directory.DirContext#search(java.lang.String,
     *      java.lang.String, java.lang.Object[],
     *      javax.naming.directory.SearchControls)
     */
    public NamingEnumeration search( String a_name, String a_filterExpr,
        Object[] a_filterArgs, SearchControls a_cons ) throws NamingException
    {
        return search( new LdapName( a_name ), a_filterExpr, a_filterArgs,
            a_cons ) ;
    }


    /**
     * TODO Factor out the filter variable code into the commons filter pkg &
     * test it there.
     * 
     * @see javax.naming.directory.DirContext#search(javax.naming.Name,
     *      java.lang.String, java.lang.Object[],
     *      javax.naming.directory.SearchControls)
     */
    public NamingEnumeration search( Name a_name, String a_filterExpr,
        Object[] a_filterArgs, SearchControls a_cons ) throws NamingException
    {
        int l_index ;
        int l_start ;
        StringBuffer l_buf = new StringBuffer( a_filterExpr ) ;
        
        // Scan until we hit the end of the string buffer 
        for ( int ii = 0; ii < l_buf.length(); ii++ )
        {
            // Advance until we hit the start of a variable
            while ( '{' != l_buf.charAt( ii ) )
            {
                ii++ ;
            }
            
            // Record start of variable at '{'
            l_start = ii ;
            
            // Advance to the end of a variable at '}'
            while ( '}' != l_buf.charAt( ii ) ) 
            {
                ii++ ;
            }
            
            // We hit end of a variable so we cut the variable index out of it
            l_index = Integer.parseInt( l_buf.substring( l_start + 1, ii ) ) ;
            
            /*
             * Replace the '{ i }' with the string representation of the value
             * held in the a_filterArgs array at index l_index.
             */           
            l_buf.replace( l_start, ii + 1, a_filterArgs[ii].toString() ) ;
        }
        
        return search( a_name, l_buf.toString(), a_cons ) ;
    }
}
